<html>
<head>
    <title>What's that song</title>
</head>
<body>
    <p>Listening for music we know.</p>

    <script>

        function startRecording(recorder) {
            recorder.start();
            console.log(recorder.state);
            console.log("recorder started");
            recorder.ondataavailable = storeChunks;

            window.setTimeout(() => stopRecording(recorder), 12 * 1000);
        }

        function stopRecording(recorder) {
            recorder.stop();
            console.log('restarting recording');
            startRecording(recorder);
        }

        async function storeChunks(e) {
            console.log(e.data);
            //const response = await postData('audiosearch', e.data);
            //console.log(response);
        }

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function (stream) {
                const options = {
                    audioBitsPerSecond: 128000,
                    videoBitsPerSecond: 2500000,
                    mimeType: 'audio/webm;codecs=pcm'
                }

                const mediaRecorder = new window.MediaRecorder(stream);
                startRecording(mediaRecorder);
            })
            .catch(function(err) {
                    console.log(`The following getUserMedia error occured: ${err}`);
                }
            );

        async function postData(url = '', data) {

            const response = await fetch(url,
                {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'audio/vnd.wave'
                    },
                    redirect: 'manual',
                    referrer: 'no-referrer',
                    body: data
                });

            return await response.json(); // parses JSON response into native JavaScript objects
        };

    </script>
</body>
</html>